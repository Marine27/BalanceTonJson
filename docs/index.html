<!DOCTYPE html>
<html lang="fr">

<head>

    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
          integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
          crossorigin=""/>
    <script
            src="https://code.jquery.com/jquery-3.5.1.min.js"
            integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
            crossorigin="anonymous"></script>
    <meta charset="UTF-8">

    <title> BalanceTonJson </title>

    <!-- Library dependancy -->
    <!--    -->
</head>

<body>
    <div class="grid-container">
        <div class="terminal">
            <div class="headterminal">
               <div id="myDropdown3" class="dropdown-content">
                <h1> Localisation </h1>
                <a href="#Icone1">
                  <form>
                      <input type="text" class="adresse_form" id="adresse"  placeholder="Saisir l'Adresse ">
                      <button href="#bouton_localisation" class="button"> Ok </button>
                      <br>
                  </form>
                </a>
              <a href="#Icone1">
                <label for="radius">Rayon de recherche</label>
                <input type="range" class="custom-range" id="radius" min="1" max="50" value="1" />
                <small id="radius-val" class="form-text text-muted">Emprise de la zone sélectionnée</small>
              </a>
            </div>
            </div>
            <div id="map" class="areaterminal map"></div>
        </div>
        <div class="files">
             <div class="headfiles">
              <div id="myDropdown1" class="dropdown-content">
                  <h1> Nombre de vélibs</h1>
                  <a>
                        <input type="text" placeholder="macxbik">
                        <br>
                        <input type="text" placeholder="minbike"><br>
                        <br>
                      <button href="#bouton_velib" class="button"> Ok </button>
                </a>
              </div>
              <div id="myDropdown2" class="dropdown-content">
                <h1> Type de monuments </h1>
                <a>
                  <select name="Monument" id="monument">
                    <option value="m1"> type monument 1 </option>
                    <option value="m2"> type monument 2</option>
                    <option value="m3"> type monument 3</option>
                    <option value="m4"> type monument  4</option>
                  </select>
                  <br>
                  <br><button  href="#bouton_monument"class="button"> Ok </button>
                </a>

              </div>
            </div>
            
            
            <div class="choosefiles">
              <div id="myDropdown4" class="dropdown-content">
                <a>
                  <button href="#lien_vers_json" class="button"> Télecharger en JSON </button>
                </a>
              </div>
              <br>
              <div id="myDropdown5" class="dropdown-content">
                <a>
                <button href="#lien_vers_rfd" class="button">  Télecharger en RFD </button>
              </a>
            </div>

            </div>
            <div class="areafiles"></div>
        </div>
        <div class="desktop">
          <a><img onclick="myFunction1()" class="icon" src="media/firefox.png" title="Use Firefox please"></a><br>
          <a><img onclick="myFunction2()" class="icon" src="media/appstore.png" title="Go snap, Go ubuntu"></a><br>
          <a><img onclick="myFunction3()" class="icon" src="media/thunderbird.png" title="send us a mail"></a><br>
          <a><img onclick="myFunction4()" class="icon" src="media/git.png" title="Our git repository is public, check it"></a><br>
          <a><img onclick="myFunction5()" class="icon" src="media/folder.png" title="API Documentation"></a><br>







        </div>
        <div class="TOP"> Activité <span class="horloge" id="timeDisplay"></span> MIASHS-M2



        </div>
        <div class="blankarea">
            <div id="rayon">
                faudra mettre la la localisation + le rayon
            </div>
            <div id="custom-test"> TEST </div>
            <label for="address">Point de départ :</label>
            <input type='text' id='address' />
            <button onclick="valid_address()"> ok </button>
            <br>
            <br>
            <label for="radius">Rayon de recherche</label>
            <input type="range" class="custom-range" id="radius" min="1" max="50" value="1" />
            <small id="radius-val" class="form-text text-muted">Emprise de la zone sélectionnée</small>

        </div>

        <script type="text/javascript" src="js/utils.js"></script>
        <script type="text/javascript" src="js/geocoder.js"></script>
        <script type="text/javascript" src="js/menu.js"></script>
        <script src="js/vendor.js" ></script>
        <script src="js/map.js" ></script>
        <script>
            let $map = document.querySelector('#map')
            let map = null
            // default parameters
            let params = {
                lat: 48.8566969,
                long: 2.3514616,
                radius: 1000,
                minbike: 1,
                maxbike: 200,
                archi: 1000
            };
            console.log(params.lat, params.long, params.radius);

            if($map != null){
                initMap([params.lat, params.long]);
            }
            //update the api
            function updateAPI() {
                let myHeaders = new Headers();
                myHeaders.append("Content-Type", "application/json");
                let url = (window.location.href == "http://localhost:3000/" ? "/" : "https://balance-ton-json.herokuapp.com/")
                url += 'locations?'
                url += 'lon=' + params.long + '&lat=' + params.lat
                url += '&radial=' + params.radius
                    //url += '&minbike='+ params.minbike + '&maxbike=' + params.maxbike 
                    //url += '&archi=' + params.archi
                fetch(url, {
                    method: 'get',
                    headers: myHeaders
                }).then(function(response) {
                    return response.json();
                }).then(function(data) {
                    console.log('data from api:', data.data);
                    importMarkers(data.data);
                });
            }

            // convert address to gps coordinates
            function getCoords(address) {
                var openStreetMapGeocoder = GeocoderJS.createGeocoder('openstreetmap');
                openStreetMapGeocoder.geocode(address, function(result) {
                    params.lat = result[0].latitude;
                    params.long = result[0].longitude;
                });
            }

            // Address selection
            const iptAddress = document.getElementById("address");

            function valid_address() {
                iptAddress.setAttribute('value', 'Paris');
                getCoords(iptAddress.value);
                console.log("newval lat", params.lat, ", newval long", params.long);
                updateAPI();
            }

            // Radius selection
            const lblRadius = document.getElementById("radius-val");
            const iptRadius = document.getElementById("radius");
            iptRadius.addEventListener("input", () => {
                const radius = parseInt(document.getElementById("radius").value);
                lblRadius.innerHTML = radius === 0 ? "Emprise de la zone sélectionnée" : radius + "km autour du centre géométrique";
                params.radius = radius * 1000
                console.log("newval radius", radius);
                updateAPI();
            });
        </script>

    </div>
</body>

</html>
